<?php

use Ke\XmlRiver\Enums\GroupByEnum;
use Ke\XmlRiver\QueryBuilders\GoogleQueryBuilder;
use Ke\XmlRiver\QueryBuilders\YandexQueryBuilder;
use Ke\XmlRiver\Requests\GoogleRequest;
use Ke\XmlRiver\Requests\YandexRequest;
use Ke\XmlRiver\XmlRiver;
use Saloon\Config;
use Saloon\Http\Faking\MockClient;
use Saloon\Http\Faking\MockResponse;
use Saloon\Http\Response;

beforeEach(function () {
    Config::preventStrayRequests();

    $this->xmlGoogleData = <<<EOT
    <?xml version="1.0" encoding="UTF-8" ?><yandexsearch version="1.0"><response date="20240115T101331"><found priority="all">6230</found><addresults><relatedSearches><query><title>Keyassort in english</title></query><query><title>spywords</title></query><query><title>кластеризация ключевых слов онлайн</title></query></relatedSearches></addresults><results><grouping><page first="1" last="8">0</page><group id="1"><doccount>1</doccount><doc><url>https://keyassort.com/</url><title>KeyAssort автоматическая кластеризация запросов ...</title><contenttype>organic</contenttype><breadcrumbs>https://keyassort.com</breadcrumbs><passages><passage>KeyAssort - программа для кластеризации запросов семантического ядра, которая сэкономит Ваше время, деньги и усилия для продвижения сайта.</passage></passages><tablesnippet></tablesnippet><sitelinks><sitelink><url>https://keyassort.com/download.html</url><title>Скачать программу KeyAssort</title><snippet></snippet></sitelink><sitelink><url>https://keyassort.com/page_buy.html</url><title>Купить</title><snippet></snippet></sitelink><sitelink><url>https://keyassort.com/overview.html</url><title>Кейсы и обзоры</title><snippet></snippet></sitelink><sitelink><url>https://keyassort.com/manual.html</url><title>Идея программы</title><snippet></snippet></sitelink></sitelinks></doc></group><group id="2"><doccount>1</doccount><doc><url>https://mobileproxy.space/en/pages/keyassort-and-mobile-proxies.html</url><title>KeyAssort and mobile proxies</title><contenttype>organic</contenttype><breadcrumbs>https://mobileproxy.space › ... › Mobile proxy articles</breadcrumbs><passages><passage>KeyAssort Program – a specialized parser designed for clustering and structuring the semantic core. The benefits of using this application in practice wil.</passage></passages><tablesnippet></tablesnippet></doc></group><group id="3"><doccount>1</doccount><doc><url>https://www.similarweb.com/website/key-assort.ru/</url><title>key-assort.ru Traffic Analytics, Ranking Stats &amp;amp; Tech Stack</title><contenttype>organic</contenttype><breadcrumbs>https://www.similarweb.com › website › key-assort</breadcrumbs><passages><passage>Reveal any website's best performing ad creatives. Develop the right messaging and formats to draw high converting traffic to your site and increase your Return...</passage></passages><tablesnippet></tablesnippet></doc></group><group id="4"><doccount>1</doccount><doc><url>https://www.amazon.com/Performance-Tool-W5343-Woodruff-Assortment/dp/B01MRV8JZ7</url><title>Performance Tool W5343 80Pc Woodruff Key Assortment ...</title><contenttype>organic</contenttype><breadcrumbs>https://www.amazon.com › Performance-Tool-W5343-...</breadcrumbs><passages><passage>Contains 8 popular sizes of woodruff keys in a convenient re-sealable plastic case; Includes the following sizes: 1/8 x 3/16 x 33/64 in, 1/8 x 1/4 x 41/64...</passage></passages><tablesnippet></tablesnippet><extendedpassage>Rating: 4.4 · ‎ 504 reviews · ‎ $14.53 · ‎ 30-day returns · ‎ In stock</extendedpassage></doc></group><group id="5"><doccount>1</doccount><doc><url>https://www.constantines.com/keyassortment.aspx</url><title>KEY ASSORTMENT</title><contenttype>organic</contenttype><breadcrumbs>https://www.constantines.com › keyassortment</breadcrumbs><passages><passage>Detailed Description. Sample Set of 12 Keys bound on 2" Ring. PLEASE NOTE: Sample Collection may vary due to availability of stock.</passage></passages><tablesnippet></tablesnippet><extendedpassage>$23.25 · ‎ 30-day returns</extendedpassage></doc></group><group id="6"><doccount>1</doccount><doc><url>https://www.huyett.com/disp-mk-wkc401</url><title>Key Form B and Woodruff Key Assort 401 Piece</title><contenttype>organic</contenttype><breadcrumbs>https://www.huyett.com › disp-mk-wkc401</breadcrumbs><passages><passage>Key Form B and Woodruff Key Carbon Steel Plain Assortment 401 piece Handi-Chek Version · Description Description · Attributes Attributes · Technical Drawing</passage></passages><tablesnippet></tablesnippet><extendedpassage>Rating: 5 · ‎ 1 review · ‎ $110.72</extendedpassage></doc></group><group id="7"><doccount>1</doccount><doc><url>https://www.ebay.com/itm/193961704170</url><title>Performance Tool W5341 80 Piece Woodruff Key Assort ...</title><contenttype>organic</contenttype><breadcrumbs>https://www.ebay.com › ... › Other</breadcrumbs><passages><passage>Performance Tool W5341 80 Piece Woodruff Key Assort Metric ... What does this price mean? This is the price (excluding shipping and handling fees) a seller has...</passage></passages><tablesnippet></tablesnippet><extendedpassage>$14.99</extendedpassage></doc></group><group id="8"><doccount>1</doccount><doc><url>https://www.shophighlinewarren.com/p/PERFW5341</url><title>Performance Tool 80 pc. Woodruff Key Assort. Metric</title><contenttype>organic</contenttype><breadcrumbs>https://www.shophighlinewarren.com › PERFW5341</breadcrumbs><passages><passage>Performance Tool 80 pc. Woodruff Key Assort. Metric · Contains 8 Popular Sizes Of Woodruff Keys · Convenient Re-Sealable Plastic Case · 4 x 7.5 x 19mm, 5 x 7.5 x...</passage></passages><tablesnippet></tablesnippet></doc></group></grouping></results></response></yandexsearch>    
    EOT;

    $this->xmlYandexData = <<<EOT
    <?xml version="1.0" encoding="UTF-8" ?><yandexsearch version="1.0"><response date="20240115T101537"><found priority="all">2000</found><addresults><relatedSearches><query><title>keyassort скачать</title></query><query><title>megaindex</title></query><query><title>topvisor</title></query><query><title>ahrefs</title></query><query><title>screaming frog seo spider</title></query><query><title>keyassort промокод</title></query><query><title>similarweb</title></query><query><title>keys.so</title></query><query><title>netpeak spider</title></query><query><title>keyauto</title></query></relatedSearches></addresults><advcount>1</advcount><topads><query><url>https://proxy-seller.io/?utm_source=yandex&amp;utm_medium=cpc&amp;utm_campaign=Keyassort&amp;utm_content=13891343100&amp;utm_term=keyassort&amp;yclid=14303347156101627903</url><title><![CDATA[Прокси для <hlword>Keyassort</hlword>. Сервис Приватных Прокси]]></title><snippet><![CDATA[Прокси для <hlword>Keyassort</hlword>. Анонимность 100%. Скорость до 1 Гбит/с. Поддержка 24/7/365.Выгодные цены. Безопасная оплата. Пакеты прокси. Под любую цель]]></snippet><oneline><sitelink><title>Продвижения Соц.Сетей</title><url>https://proxy-seller.io/proxy-for-another-social-network/?utm_source=yandex&amp;utm_medium=cpc&amp;utm_campaign=86151994&amp;utm_content=13891343100&amp;utm_term=keyassort&amp;yclid=14303347156101627903</url></sitelink><sitelink><title>Парсинг</title><url>https://proxy-seller.io/?utm_source=yandex&amp;utm_medium=cpc&amp;utm_campaign=86151994&amp;utm_content=13891343100&amp;utm_term=keyassort&amp;yclid=14303347156101627903</url></sitelink><sitelink><title>Ставки</title><url>https://proxy-seller.io/proxy-for-another-bookmakers/?utm_source=yandex&amp;utm_medium=cpc&amp;utm_campaign=86151994&amp;utm_content=13891343100&amp;utm_term=keyassort&amp;yclid=14303347156101627903</url></sitelink><sitelink><title>Под любую твою цель</title><url>https://proxy-seller.io/?utm_source=yandex&amp;utm_medium=cpc&amp;utm_campaign=86151994&amp;utm_content=13891343100&amp;utm_term=keyassort&amp;yclid=14303347156101627903</url></sitelink></oneline></query></topads><bottomads><query><url>https://proxy-seller.io/?utm_source=yandex&amp;utm_medium=cpc&amp;utm_campaign=Keyassort&amp;utm_content=13891343100&amp;utm_term=keyassort&amp;yclid=14303347156101627903</url><title><![CDATA[Прокси для <hlword>Keyassort</hlword>. Сервис Приватных Прокси]]></title><snippet><![CDATA[Прокси для <hlword>Keyassort</hlword>. Анонимность 100%. Скорость до 1 Гбит/с. Поддержка 24/7/365.Выгодные цены. Безопасная оплата. Пакеты прокси. Под любую цель]]></snippet><oneline><sitelink><title>Продвижения Соц.Сетей</title><url>https://proxy-seller.io/proxy-for-another-social-network/?utm_source=yandex&amp;utm_medium=cpc&amp;utm_campaign=86151994&amp;utm_content=13891343100&amp;utm_term=keyassort&amp;yclid=14303347156101627903</url></sitelink><sitelink><title>Парсинг</title><url>https://proxy-seller.io/?utm_source=yandex&amp;utm_medium=cpc&amp;utm_campaign=86151994&amp;utm_content=13891343100&amp;utm_term=keyassort&amp;yclid=14303347156101627903</url></sitelink><sitelink><title>Ставки</title><url>https://proxy-seller.io/proxy-for-another-bookmakers/?utm_source=yandex&amp;utm_medium=cpc&amp;utm_campaign=86151994&amp;utm_content=13891343100&amp;utm_term=keyassort&amp;yclid=14303347156101627903</url></sitelink><sitelink><title>Под любую твою цель</title><url>https://proxy-seller.io/?utm_source=yandex&amp;utm_medium=cpc&amp;utm_campaign=86151994&amp;utm_content=13891343100&amp;utm_term=keyassort&amp;yclid=14303347156101627903</url></sitelink></oneline></query></bottomads><results><grouping><page first="1" last="10">1</page><group id="1"><doccount>1</doccount><doc><url>https://keyassort.com/</url><title>KeyAssort автоматическая кластеризация запросов...</title><contenttype>organic</contenttype><passages><passage>KeyAssort - программа для кластеризации запросов семантического ядра, которая сэкономит Ваше время, деньги и усилия для продвижения сайта...</passage></passages><tablesnippet></tablesnippet><sitelinks><sitelink><url>https://keyassort.com/download.html</url><title>Скачать</title><snippet>✅ Скачать программу KeyAssort или демо-версию без ограничений по...</snippet></sitelink><sitelink><url>https://keyassort.com/fast-start.html</url><title>Быстрый старт</title><snippet>Видео-инструкция "Быстрый старт.</snippet></sitelink><sitelink><url>https://keyassort.com/instructions.html</url><title>Текстовая инструкция</title><snippet>Как пользоваться программой KeyAssort? Научиться обращаться...</snippet></sitelink><sitelink><url>https://keyassort.com/manual.html</url><title>Идея программы</title><snippet>Для каких целей была спроектирована программа KeyAssort, для чего вы...</snippet></sitelink><sitelink><url>https://keyassort.com/client/login</url><title>Кабинет</title><snippet>Регистрационные данные были высланы Вам на почту при первом...</snippet></sitelink><sitelink><url>https://keyassort.com/history.html</url><title>История изменений</title><snippet>История версий программы KeyAssort с начала паблик-релиза, как мы...</snippet></sitelink><sitelink><url>https://keyassort.com/support/</url><title>Служба Поддержки</title><snippet>Перед обращением в поддержку, убедитесь, что Вы прочитали...</snippet></sitelink><sitelink><url>https://keyassort.com/overview.html</url><title>Кейсы и обзоры</title><snippet>На этой страничке собраны ссылки на наиболее интересные кейсы...</snippet></sitelink></sitelinks><extendedpassages></extendedpassages></doc></group><group id="2"><doccount>1</doccount><doc><url>https://www.youtube.com/watch?v=Kb3KWeAFc7U</url><title>Кей Ассорт (KeyAssort) - настройка и работа в программе...</title><contenttype>organic</contenttype><passages><passage></passage></passages><tablesnippet></tablesnippet><extendedpassages></extendedpassages></doc></group><group id="3"><doccount>1</doccount><doc><url>https://devaka.info/articles/keyassort</url><title>KeyAssort — самый удобный инструмент для...</title><contenttype>organic</contenttype><passages><passage>KeyAssort — это десктопная программа, созданная специально для кластеризации семантического ядра.</passage></passages><tablesnippet></tablesnippet><extendedpassages></extendedpassages></doc></group><group id="4"><doccount>1</doccount><doc><url>https://semantica.in/blog/obzor-na-servis-dlya-klasterizaczii-zaprosov-keyassort.html</url><title>Кластеризатор запросов KeyAssort</title><contenttype>organic</contenttype><passages><passage>Проект создан, приступим к самой кластеризации. Кластеризация в KeyAssort. Для начала соберём данные, необходимые для этого процесса.</passage></passages><tablesnippet></tablesnippet><extendedpassages></extendedpassages></doc></group><group id="5"><doccount>1</doccount><doc><url>https://vc.ru/tribuna/553976-keyclusterer-2-6-ugnatsya-za-key-collector-i-keyassort</url><title>KeyClusterer 2.6 - угнаться за Key Collector и KeyAssort</title><contenttype>organic</contenttype><passages><passage>Всем привет, меня зовут Симагин Андрей, и сегодня я хочу представить обновление KeyClusterer - десктопной программы, предназначенной для кластеризации...</passage></passages><tablesnippet></tablesnippet><extendedpassages></extendedpassages></doc></group><group id="6"><doccount>1</doccount><doc><url>https://vk.com/@habr_articles-rss-650396164-566036482</url><title>Программа для автоматической кластеризации поисковых...</title><contenttype>organic</contenttype><passages><passage>Программа для кластеризации семантического ядра KeyAssort. Этим софтом пользуются многие профессиональные оптимизаторы, например, Сергей Кокшаров.</passage></passages><tablesnippet></tablesnippet><extendedpassages></extendedpassages></doc></group><group id="7"><doccount>1</doccount><doc><url>https://Key-assort.ru/</url><title>Скачать KeyAssort + промокод 2024 на вторую лицензию...</title><contenttype>organic</contenttype><passages><passage>Настройки XMLproxy для KeyAssort. XML (eXtensible Markup Language) — в дословном переводе с английского «расширяемый язык разметки».</passage></passages><tablesnippet></tablesnippet><extendedpassages></extendedpassages></doc></group><group id="8"><doccount>1</doccount><doc><url>https://stokrat.org/blog/dolbim-didzhital/klasterizatsiya-semanticheskogo-yadra-s-pomoshchyu-keyassort/</url><title>Кластеризация ядра в KeyAssort – детальный анализ...</title><contenttype>organic</contenttype><passages><passage>Как кластеризировать семантическое ядро с помощью KeyAssort и какое отношение она имеет к Key Collector дельные советы от SEO специалистов из компании...</passage></passages><tablesnippet></tablesnippet><extendedpassages></extendedpassages></doc></group><group id="9"><doccount>1</doccount><doc><url>https://habr.com/ru/articles/354986/</url><title>Сравнение сервисов автоматической кластеризации...</title><contenttype>organic</contenttype><passages><passage>В качестве оптимального решения для нашего проекта была выбрана программа KeyAssort – это именно программа, а не онлайн-сервис, лицензия покупается...</passage></passages><tablesnippet></tablesnippet><extendedpassages></extendedpassages></doc></group><group id="10"><doccount>1</doccount><doc><url>https://www.sbup.com/seo-forum/seo_servisy__seo_instrumenty_i_seo_utility/keyassort___programma_dlya_klasterizacii_gruppirovki_poiskovyh_zaprosov/20/</url><title>KeyAssort - программа для кластеризации (группировки)...</title><contenttype>organic</contenttype><passages><passage></passage></passages><tablesnippet></tablesnippet><extendedpassages></extendedpassages></doc></group></grouping></results></response></yandexsearch>
    EOT;

    $this->mockClient = new MockClient([
        GoogleRequest::class => MockResponse::make($this->xmlGoogleData, 200),
        YandexRequest::class => MockResponse::make($this->xmlYandexData, 200),
    ]);

    $this->xmlRiver = new XmlRiver(123, 'bar');

    $this->xmlRiver->withMockClient($this->mockClient);
});

test('it can get google response', function () {
    $googleQueryBuilder = new GoogleQueryBuilder();

    $googleQueryBuilder
        ->query('keyassort')
        ->groupBy(GroupByEnum::TEN);
        
    $response = $this->xmlRiver->getResponse($googleQueryBuilder);

    $data = $response->dto()->data();

    expect($response->status())->toBe(200)
        ->and($response)->toBeInstanceOf(Response::class)
        ->and($data)->{0}->position->toBe(1)
        ->and($data)->{0}->url->toBe("https://keyassort.com/");

    $this->mockClient->assertSent(GoogleRequest::class);
});

test('it can get yandex response', function () {
    $yandexQueryBuilder = new YandexQueryBuilder();

    $yandexQueryBuilder->query('keyassort');
        
    $response = $this->xmlRiver->getResponse($yandexQueryBuilder);

    $data = $response->dto()->data();

    expect($response->status())->toBe(200)
        ->and($response)->toBeInstanceOf(Response::class)
        ->and($data)->{0}->position->toBe(1)
        ->and($data)->{0}->url->toBe("https://keyassort.com/");

    $this->mockClient->assertSent(YandexRequest::class);
});
